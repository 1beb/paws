#' Add the SDK for a given API
#'
#' @param api_name Name of the API to make a package for.
#' @param in_dir Directory containing API files.
#' @param out_dir Directory of the R package.
write_sdk_for_api <- function(api_name, in_dir, out_dir) {
  api <- read_api(api_name, in_dir)
  write_code(api, out_dir)
  write_tests(api, out_dir)
  return(invisible(TRUE))
}

#-------------------------------------------------------------------------------

# Write code for a given API
write_code <- function(api, path) {
  r_dir <- file.path(path, "R")
  write_operations(api, r_dir)
  write_interfaces(api, r_dir)
  write_service(api, r_dir)
  copy_customizations(api, r_dir)
  return(TRUE)
}

# Generate the operations and write them to a file in the package.
write_operations <- function(api, path) {
  operations <- make_operations(api)
  package <- package_name(api)
  filename <- paste0(package, "_operations.R")
  operations <- add_edit_warning(operations)
  write_list(operations, file.path(path, filename))
}

# Generate the interfaces and write them to a file in the package.
write_interfaces <- function(api, path) {
  interfaces <- make_interfaces(api)
  package <- package_name(api)
  filename <- paste0(package, "_interfaces.R")
  interfaces <- add_edit_warning(interfaces)
  write_list(interfaces, file.path(path, filename))
}

# Generate the service info and write it to a file in the package.
write_service <- function(api, path) {
  service <- make_service(api)
  package <- package_name(api)
  filename <- paste0(package, "_service.R")
  service <- add_edit_warning(service)
  write_list(service, file.path(path, filename))
}

# Copy customizations for a given package, if there are any.
copy_customizations <- function(api, path) {
  path_in <- system_file("src", "customizations", package = methods::getPackageName())
  files <- list.files(path_in, full.names = TRUE)
  service <- tolower(struct_name(api))
  src_file <- files[grep(sprintf("^%s.R$", service), basename(files))]
  if (length(src_file) > 0) {
    package <- package_name(api)
    filename <- sprintf("%s_customizations.R", package)
    warning_text <- unlist(add_edit_warning(list(), new_line = T))
    write(warning_text, file = file.path(path, filename))
    file.append(file.path(path, filename), src_file)
  }
}

# Generate tests for the package and write them to the tests folder.
write_tests <- function(api, path) {
  package <- package_name(api)
  filename <- paste0("test_", package, ".R")
  test_path <- file.path(path, "tests")
  tests <- make_tests(api)
  tests <- add_edit_warning(tests)
  write_list(tests, file.path(test_path, "testthat", filename))
}

# Add a Roxygen directive to the top of a file.
add_roxygen_directive <- function(text, directive) {
  header <- sprintf("#' %s\nNULL", directive)
  result <- c(header, text)
  return(result)
}

# Add a warning saying not to edit the generated file.
add_edit_warning <- function(text, new_line = FALSE) {
  warning <- "# This file is generated by make.paws. Please do not edit here."
  if (new_line) warning <- c(warning, "")
  result <- c(warning, text)
  return(result)
}

# Write a list of code objects to a file, separated by newlines. Create
# directories if necessary.
write_list <- function(list, file) {
  contents <- paste(list, collapse = "\n\n")
  path <- dirname(file)
  dir.create(path, showWarnings = FALSE, recursive = TRUE)
  write_utf8(contents, file)
}
