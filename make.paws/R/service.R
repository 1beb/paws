#' @include templates.R
NULL

service_file_template <- template(
  `
  # This file is generated by make.paws. Please do not edit here.
  #' @importFrom paws.common new_handlers new_service
  NULL

  ${docs}
  #' @rdname ${service}
  #' @export
  ${service} <- list()

  # Private API objects: metadata, handlers, interfaces, etc.
  .${service} <- list()

  .${service}$metadata <- list(
    service_name = ${service_name},
    endpoints = ${endpoints},
    service_id = ${service_id},
    api_version = ${api_version},
    signing_name = ${signing_name},
    json_version = ${json_version},
    target_prefix = ${target_prefix}
  )

  .${service}$handlers <- new_handlers(${protocol}, ${signer})

  .${service}$service <- function() {
    return(new_service(.${service}$metadata, .${service}$handlers))
  }
  `
)

# Returns the service file which sets up the objects needed to make requests to
# a specific AWS API, e.g. the request handlers and request signer.
make_service <- function(api) {
  render(
    service_file_template,
    title = service_title(api),
    details = service_details(api),
    service = package_name(api),
    protocol = protocol_package(api),
    signer = quoted(api$metadata$signatureVersion),
    service_name = quoted(service_name(api)),
    endpoints = endpoint_data(api),
    service_id = quoted(service_id(api)),
    api_version = quoted(api$metadata$apiVersion),
    signing_name = signing_name(api),
    json_version = json_version(api),
    target_prefix = target_prefix(api)
  )
}

#-------------------------------------------------------------------------------

# Return the API title.
service_title <- function(api) {
  api$metadata$serviceFullName
}

# Return the API description.
service_description <- function(api) {

}

# Returns the standardized protocol name used by an API.
# e.g. rest-json -> restjson.
protocol_package <- function(api) {
  protocol <- api$metadata$protocol
  if (protocol == "json") protocol <- "jsonrpc"
  else if (protocol == "ec2") protocol <- "ec2query"
  else protocol <- gsub("\\-", "", protocol)
  return(quoted(protocol))
}

# Returns the signing name for an API, either the signing name specified in the
# API definition or the signing name assigned by `client_config`.
signing_name <- function(api) {
  name <- api$metadata$signingName
  if (!is.null(name)) return(quoted(name))
  return("NULL")
}

endpoint_data <- function(api) {
  get_structure(api$region_config)
}

# Returns the JSON version for the API, or "" if none.
json_version <- function(api) {
  version <- api$metadata$jsonVersion
  if (is.null(version)) version <- ""
  return(quoted(version))
}

# Returns the target prefix for the API, or "" if none.
target_prefix <- function(api) {
  prefix <- api$metadata$targetPrefix
  if (is.null(prefix)) prefix <- ""
  return(quoted(prefix))
}
